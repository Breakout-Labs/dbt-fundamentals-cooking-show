version: 2

models:
  - name: orders
    description: >
      Order fact table with delivery timing metrics. Includes calculated fields for delivery time from both order placement and pickup.
    data_tests:
      - dbt_utils.expression_is_true:
          expression: "delivery_time_from_order >= delivery_time_from_collection"
          config:
            where: "delivery_time_from_order is not null and delivery_time_from_collection is not null"
            severity: error
      - dbt_utils.expression_is_true:
          expression: "order_status != 'delivered' or delivery_time_from_order is not null"
          config:
            severity: warn
            
    columns:
      - name: order_id
        description: Unique identifier for the order. Primary key.
        data_tests:
          - unique
          - not_null

      - name: customer_id
        description: Foreign key to the customer who placed the order
        data_tests:
          - not_null

      - name: ordered_at
        description: Timestamp when the order was placed in UTC
        data_tests:
          - not_null
        
      - name: order_status
        description: Current status of the order
        data_tests:
          - not_null
          - accepted_values:
              config:
                severity: warn
              values: ['cancelled', 'pending', 'ordered', 'delivered']

      - name: total_amount
        description: Total order amount in dollars
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              config:
                severity: error

      - name: delivery_time_from_order
        description: Time in minutes from order placement to delivery. Null if not yet delivered.
        data_tests:
          - dbt_utils.accepted_range:
              min_value: 0
              config:
                where: "delivery_time_from_order is not null"
                severity: error

      - name: delivery_time_from_collection
        description: Time in minutes from pickup to delivery. Null if not yet delivered.
        data_tests:
          - dbt_utils.accepted_range:
              min_value: 0
              config:
                where: "delivery_time_from_collection is not null"
                severity: error

  - name: orders_by_category_monthly
    description: >
      Monthly aggregated sales metrics by product category.
    data_tests:
      - dbt_utils.expression_is_true:
          expression: "total_revenue >= 0"
          config:
            severity: error
      
      - dbt_utils.expression_is_true:
          expression: "total_quantity_sold >= 0"
          config:
            severity: error

    columns:
      - name: order_month
        description: The month for which metrics are aggregated in YYYY-MM format.
        data_tests:
          - not_null

      - name: category
        description: The main product category.
        data_tests:
          - not_null

      - name: subcategory
        description: The product subcategory.

      - name: order_count
        description: Total number of distinct orders containing products from this category in the month.
        data_tests:
          - not_null

      - name: total_quantity_sold
        description: Total quantity of products sold in this category during the month.
        data_tests:
          - not_null

      - name: total_revenue
        description: Total revenue generated by this category in the month.
        data_tests:
          - not_null

      - name: average_unit_price
        description: Average unit price across all products in this category for the month.